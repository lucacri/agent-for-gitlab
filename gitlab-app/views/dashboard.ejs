<div class="d-flex justify-between align-center mb-4">
    <h1>Dashboard</h1>
    <div class="text-muted">
        Welcome back, <%= user.username %>
    </div>
</div>

<div class="card">
    <div class="d-flex justify-between align-center mb-3">
        <h2 class="mb-0">Your Projects</h2>
        <div class="text-muted">
            <%= projectCount %> total projects
        </div>
    </div>

    <div id="projects-container">
        <div class="text-center mb-3">
            <button id="load-projects" class="btn">Load GitLab Projects</button>
        </div>
        
        <div id="projects-list" style="display: none;">
            <!-- Projects will be loaded here -->
        </div>
    </div>
</div>

<% if (projects.length > 0) { %>
<div class="card">
    <h2 class="mb-3">Claude-Enabled Projects</h2>
    <div style="display: grid; gap: 1rem;">
        <% projects.forEach(project => { %>
        <div class="d-flex justify-between align-center" style="padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
            <div>
                <strong><%= project.name %></strong>
                <div class="text-muted"><%= project.path %></div>
            </div>
            <div class="d-flex gap-1">
                <a href="/dashboard/project/<%= project.gitlabProjectId %>" class="btn btn-secondary">Settings</a>
                <button class="btn btn-danger" onclick="disableProject(<%= project.gitlabProjectId %>)">Disable</button>
            </div>
        </div>
        <% }); %>
    </div>
</div>
<% } %>

<script>
document.getElementById('load-projects').addEventListener('click', async () => {
    const button = document.getElementById('load-projects');
    const list = document.getElementById('projects-list');
    
    button.textContent = 'Loading...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        if (projects.length === 0) {
            list.innerHTML = '<p class="text-muted text-center">No projects found. Make sure you have at least Developer access to GitLab projects.</p>';
        } else {
            list.innerHTML = projects.map(project => `
                <div class="d-flex justify-between align-center" style="padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem;">
                    <div class="d-flex align-center gap-2">
                        ${project.avatar_url ? `<img src="${project.avatar_url}" alt="${project.name}" style="width: 32px; height: 32px; border-radius: 4px;">` : ''}
                        <div>
                            <strong>${project.name}</strong>
                            <div class="text-muted">${project.path_with_namespace}</div>
                            ${project.description ? `<div class="text-muted" style="font-size: 0.85rem;">${project.description}</div>` : ''}
                        </div>
                    </div>
                    <div class="d-flex align-center gap-1">
                        ${project.claudeEnabled ? 
                            `<span style="color: #28a745; font-weight: 500;">âœ“ Enabled</span>
                             <button class="btn btn-danger" onclick="disableProject(${project.id})">Disable</button>` :
                            `<button class="btn btn-success" onclick="enableProject(${project.id})">Enable Claude</button>`
                        }
                        <a href="${project.web_url}" target="_blank" class="btn btn-secondary">Open</a>
                    </div>
                </div>
            `).join('');
        }
        
        list.style.display = 'block';
        button.style.display = 'none';
        
    } catch (error) {
        console.error('Failed to load projects:', error);
        alert('Failed to load projects. Please try again.');
        button.textContent = 'Load GitLab Projects';
        button.disabled = false;
    }
});

async function enableProject(projectId) {
    try {
        const response = await fetch(`/api/projects/${projectId}/enable`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert(`Failed to enable project: ${error.error}`);
        }
    } catch (error) {
        console.error('Failed to enable project:', error);
        alert('Failed to enable project. Please try again.');
    }
}

async function disableProject(projectId) {
    if (!confirm('Are you sure you want to disable Claude for this project? This will remove the webhook.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectId}/disable`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert(`Failed to disable project: ${error.error}`);
        }
    } catch (error) {
        console.error('Failed to disable project:', error);
        alert('Failed to disable project. Please try again.');
    }
}
</script>